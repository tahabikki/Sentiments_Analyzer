<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Sentiment & Emotion Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background: #f4f5f7; 
            font-family: 'Segoe UI', sans-serif;
        }
        .container { max-width: 1200px; }
        .card { margin-bottom: 20px; }
        .chart-container { height: 350px; }
        #result-card pre { background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .option-btn { width: 150px; margin: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center mb-4 fw-bold">AI Sentiment & Emotion Analyzer</h1>

    <!-- Choose Input Type -->
    <div class="text-center mb-4">
        <button class="btn btn-primary option-btn" id="choose-text">Text</button>
        <button class="btn btn-success option-btn" id="choose-image">Image</button>
    </div>

    <!-- Text Input Form -->
    <div id="text-form" class="card shadow-sm hidden">
        <div class="card-body">
            <h5 class="card-title">Enter Text</h5>
            <form id="analyze-text-form">
                <div class="mb-3">
                    <textarea class="form-control" name="text" rows="5" placeholder="Type your text here..." required></textarea>
                </div>
                <button class="btn btn-primary w-100" type="submit">Analyze Text</button>
            </form>
        </div>
    </div>

    <!-- Image Input Form -->
    <div id="image-form" class="card shadow-sm hidden">
        <div class="card-body">
            <h5 class="card-title">Upload Image</h5>
            <form id="analyze-image-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <input type="file" class="form-control" name="image" accept="image/*" required>
                </div>
                <button class="btn btn-success w-100" type="submit">Analyze Image</button>
            </form>
        </div>
    </div>

    <!-- Result Card -->
    <div id="result-card" class="card shadow-sm mt-3 hidden">
        <div class="card-body">
            <h5 class="card-title">Latest Analysis</h5>
            <p><strong>Sentiment:</strong> <span id="sentiment"></span></p>
            <p><strong>Emotion:</strong></p>
            <pre id="emotion"></pre>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm chart-container mb-3">
                <div class="card-body">
                    <h5 class="card-title">Sentiment Trend</h5>
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm chart-container">
                <div class="card-body">
                    <h5 class="card-title">Emotion Radar</h5>
                    <canvas id="emotionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- History Table -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h5 class="card-title">History (Last 50)</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Text / Image Text</th>
                            <th>Sentiment</th>
                            <th>Emotion</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
            <button class="btn btn-danger" id="clear-history">Clear History</button>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
let sentimentChart, emotionChart;

// Choose input type
document.getElementById('choose-text').addEventListener('click', () => {
    document.getElementById('text-form').classList.remove('hidden');
    document.getElementById('image-form').classList.add('hidden');
});
document.getElementById('choose-image').addEventListener('click', () => {
    document.getElementById('image-form').classList.remove('hidden');
    document.getElementById('text-form').classList.add('hidden');
});

// Fetch and update history/charts
async function fetchHistory() {
    const res = await fetch("/history");
    const data = await res.json();

    // Table
    const tbody = document.getElementById('history-body');
    tbody.innerHTML = '';
    data.forEach(entry => {
        const row = `<tr>
            <td>${entry.date}</td>
            <td>${entry.text.length>50? entry.text.slice(0,50)+'...' : entry.text}</td>
            <td>${entry.sentiment.label}</td>
            <td>${JSON.stringify(entry.emotion)}</td>
        </tr>`;
        tbody.innerHTML += row;
    });

    // Charts
    const sentimentCounts = { "positive":0, "neutral":0, "negative":0 };
    const emotionLabels = ["sadness","joy","anger","fear","neutral","frustration","anxiety","worry"];
    const emotionSums = {}; emotionLabels.forEach(l=>emotionSums[l]=0);
    data.forEach(e=>{
        const s = e.sentiment.label?.toLowerCase();
        if(s && sentimentCounts[s]!==undefined) sentimentCounts[s]++;
        for(let key of emotionLabels) if(e.emotion[key]) emotionSums[key]+=e.emotion[key];
    });

    if(!sentimentChart){
        const ctxS = document.getElementById('sentimentChart').getContext('2d');
        sentimentChart = new Chart(ctxS, { type:'bar', data:{ labels:Object.keys(sentimentCounts), datasets:[{ label:'Number of Texts', data:Object.values(sentimentCounts), backgroundColor:['green','gray','red'] }] }, options:{ responsive:false, plugins:{legend:{display:false}} }});
    } else { sentimentChart.data.datasets[0].data=Object.values(sentimentCounts); sentimentChart.update(); }

    if(!emotionChart){
        const ctxE = document.getElementById('emotionChart').getContext('2d');
        emotionChart = new Chart(ctxE, { type:'radar', data:{ labels:emotionLabels, datasets:[{ label:'Emotion Scores', data:Object.values(emotionSums), backgroundColor:'rgba(54,162,235,0.3)', borderColor:'rgba(54,162,235,1)', borderWidth:2 }] }, options:{ responsive:false, scales:{ r:{min:0} } }});
    } else { emotionChart.data.datasets[0].data=Object.values(emotionSums); emotionChart.update(); }
}

// Analyze form submissions
async function analyzeFormSubmit(form, type){
    form.addEventListener('submit', async e=>{
        e.preventDefault();
        const formData = new FormData(form);
        const res = await fetch("/analyze", { method:"POST", body:formData });
        const result = await res.json();
        if(result.success){
            document.getElementById('result-card').classList.remove('hidden');
            document.getElementById('sentiment').innerText=result.result.sentiment.label;
            document.getElementById('emotion').innerText=JSON.stringify(result.result.emotion, null, 2);
            fetchHistory();
        } else alert(result.error || "Error analyzing input");
    });
}
analyzeFormSubmit(document.getElementById('analyze-text-form'), 'text');
analyzeFormSubmit(document.getElementById('analyze-image-form'), 'image');

// Clear history
document.getElementById('clear-history').addEventListener('click', async ()=>{
    if(confirm("Are you sure to clear history?")){
        await fetch("/clear_history",{method:"POST"});
        fetchHistory();
        document.getElementById('result-card').classList.add('hidden');
    }
});

// Initial load
fetchHistory();
</script>
</body>
</html>
